# Imports
library(ecp)

# SPECIFY DESIRED NAME/PATH OF OUTPUT .CSV
changepoints_csv_name = "/Users/madelinehamilton/Documents/python_stuff/bimmuda_dom/output_data/changepoints.csv"

# This file takes the smoothed time series and performs changepoint detection with e.divisive
# (https://www.rdocumentation.org/packages/ecp/versions/3.1.3/topics/e.divisive)
# over several parameter settings and outputs a .csv with the changepoints found at these
# different settings

# Input in the 7 smoothed time series manually (fix this)
# Tonality
tonality <- c(0.7322861114260620,	0.7466107398924940,	0.7461744873004720,	0.7491114591148010,	0.735701530592164,0.7245625506490500,	0.7342221531910950,	0.7354222598198730,	0.734126657642887,	0.750227342045523,	0.7664824136351910,	0.7657400968639160,	0.7495036913510950,	0.7456299567353600,	0.7387966824752010,	0.7383686580130720,	0.7352624468476030,	0.751674565898226,	0.7553890301599640,	0.7566228464114020,	0.754074177952363,	0.7377858159758650,	0.7399348369053740,	0.7454251599750600,	0.7365126462350890,	0.7409412761534650,	0.7543796694058540,	0.7586957589542700,	0.7507046668258910,	0.7675711186833110,	0.7586895895303420,	0.75158828746711,	0.7458979499572550,	0.7435400859535880,	0.7398511297909400,	0.7362784087251690,	0.7426979098742500,	0.7339868787903550,	0.7413599274661380,	0.7360169969983470,	0.7462995849952440,	0.7459295288885860,	0.7504155610809170,	0.7449929281182450,	0.7454650605860500,	0.7449799425013760,	0.7394018489046810,	0.7377904050200760,	0.733498806433392,	0.7185834859758610,	0.7090291745602810,	0.7008697863485060,	0.7140976386083120,	0.715919597156174,	0.7238007710060750,	0.728587768011682,	0.7394649456053720,	0.7291023925282640,	0.7368973953081280,	0.736178674545366,	0.7362242281496550,	0.7374367634718870,	0.734526887234641,	0.722722725923542,	0.7266033729611750,	0.7243459021180930,	0.7166676899045430,	0.7113344816630020)
# Melodic Information Content
mic <- c(4.469638581955710,	4.492760355955710,	4.4530564541375300,	4.323155840804200,	4.119969347119990,	4.120338047119990,	4.054161547889220,	4.0286126387983100,	4.182468241298310,	4.273215980437060,	4.236705450217280,	4.335231233993510,	4.143496962664840,	3.896986106983020,	3.828949326528470,	3.8191571111713300,	3.7785678232925400,	3.960905099220140,	4.069552861038320,	4.154609679371660,	4.096304749371660,	4.076753414133560,	3.9196835858982700,	3.908647050039680,	3.6852896761181100,	3.630862848618110,	3.6396341357609700,	3.7540994424276400,	3.5975690296498600,	3.681345338571430,	3.7360376294805200,	3.6995580462032100,	3.7425606282865400,	3.7290112652865400,	3.7204255963649700,	3.637232019368930,	3.628872249408140,	3.590902798552880,	3.636607682552880,	3.695041861141110,	3.85648217347807,	3.78920588547807,	3.691926273833330,	3.7893236151666700,	3.704654513833330,	3.57794563425,	3.57455002515196,	3.4924767169972000,	3.2959923577591000,	3.0352027937591000,	2.972186544739500,	2.948027367092440,	2.9430761361400600,	2.9645698285210100,	3.0305162264907100,	3.0454558558436500,	3.030150271409260,	2.947266077950610,	2.933789729827360,	2.9144756803910000,	2.899927185155700,	2.8050600442650200,	2.859112843212380,	2.838219039907060,	2.8783969255491700,	2.802801165363410,	2.9092769989891400,	2.883641747690890)
# Pitch STD
pitch_std <- c(3.552430527869620,	3.4763848321652300,	3.471914394450970,	3.5194409209667900,	3.4105505866229000,	3.4141053433316800,	3.3274410441017700,	3.3097410248923800,	3.56620557987297,	3.622458620496090,	3.728263584949060,	3.646111326113550,	3.3986334403118900,	2.9392980006872500,	2.8662612210772100,	2.9131293022980800,	3.0102955864029300,	3.148881240692960,	3.323819455211820,	3.466175118727760,	3.380750530741890,	3.3363207155625800,	3.369794837338460,	3.3191326806124700,	3.1459780719353700,	3.0499638965181900,	3.056586247256830,	3.036538607661930,	2.878459061261100,	2.8859011668283700,	2.899044981477990,	2.836191391267080,	2.9076049544100500,	2.8526989735894000,	2.9064912301676300,	2.8633871706114600,	2.876396896068560,	2.7323392733277800,	2.8303036193737500,	2.8245279250454300,	2.9256300625538300,	2.992021573141310,	3.0448399268888800,	3.0621457937787600,	3.0753246619851200,	3.055927899127980,	3.0029784271357500,	2.9904937970902500,	2.9005662135167000,	2.7259553510436200,	2.686887273783980,	2.6272910488719300,	2.7203185117855300,	2.713008518283710,	2.7922371163706800,	2.7955600675081300,	2.774903171246270,	2.6334731489734800,	2.771201355306880,	2.727798389891840,	2.7375725825294400,	2.792547985379260,	2.7830171763916300,	2.6928687738435400,	2.722222681304640,	2.6761404650981500,	2.6963655797211000,	2.694714253983810)
# Melodic Interval Size
mis <- c(2.4231993279086500,	2.5426904621178400,	2.5201982917289900,	2.41038391821049,	2.311445284697280,	2.2971789893259400,	2.2310713844142100,	2.2100814463886000,	2.557780513184190,	2.6013625750422800,	2.5755025635512300,	2.50495145035362,	2.423360481886970,	2.029965856041430,	1.9788883953155100,	2.0476555022910100,	2.1118620303101900,	2.190468784219120,	2.1822478204107900,	2.288824024911840,	2.2754950959154000,	2.2278703157758700,	2.2801305924496900,	2.303683715989760,	2.1215553668992600,	2.157923914749780,	2.2260540052903100,	2.1703520878655400,	2.1254702898254800,	2.1633830643748600,	2.0795783760324000,	2.0177058429825300,	2.08757268381628,	2.0369524189824100,	2.125132094773270,	2.099909270109250,	2.089825345818990,	1.9827241342102000,	2.091944110317270,	2.1088567620103200,	2.1827291132808600,	2.1330288012984700,	2.11934713400384,	2.049321660978230,	2.0313419120795900,	1.9647618534655200,	2.0337696595712700,	2.0713267517208600,	2.1002799437746500,	1.9898272255199800,	2.0608887155347400,	2.037545950996970,	2.0240994941309100,	1.993955139248330,	2.0139321451074800,	2.0180818072043100,	2.0154174463932500,	1.9523819235267400,	1.9733256336005800,	1.8980840765462000,	1.8759170913582300,	1.8125876913476600,	1.8649400602738800,	1.8368830193180600,	1.9164042744221400,	1.8854838206500200,	1.9291740698526900,	1.9601699479730200)
# Onset Density
od <- c(1.7210040626009700,	1.6497379034996300,	1.611710305823360,	1.6594832632725500,	1.8480117644813000,	1.8837261420314800,	1.8161861664736200,	1.834547971626390,	1.8000111234548700,	1.7235044819254500,	1.693932714834080,	1.7394222481401100,	1.8368708096783700,	1.9608917898654700,	1.9472055351395000,	1.9962931362498300,	1.9882545282072700,	1.9466464099421300,	1.941748810280240,	1.9229067064204700,	1.9205910631540700,	1.9388000906201700,	1.9371956173984900,	1.9255770571888800,	2.0281830922870900,	2.019412976070880,	1.9809874220118700,	1.943151921190660,	2.052820617740090,	2.062489557354750,	2.077551831793420,	2.159875318006560,	2.1121705506089600,	2.0549906183952600,	2.066396020269810,	2.0858143451313000,	2.065855791672410,	2.12014252459806,	2.0777727290827500,	1.9131106687082200,	1.8013079933752200,	1.820701338947100,	1.9283101906390300,	1.938361941652830,	2.0682443410670100,	2.1889715024556200,	2.222658959858800,	2.241750259447120,	2.3808825211721600,	2.6269827329621000,	2.6821936219240000,	2.788276473722280,	2.876020859844920,	2.829194101755460,	2.676679418586080,	2.710468408470690,	2.596577276433460,	2.5264488350023600,	2.5075293012758000,	2.5861410512142200,	2.517323954893950,	2.6345469072945600,	2.6962907369420000,	2.8254489504470000,	2.773090225454550,	2.9285635199948700,	2.929852561392520,	3.0005428966587600)
# nPVI
npvi <- c(56.50169246484600,	56.01125919809920,	55.542458955603500,	56.568798927814,	52.38494253003880,	48.92183937077710,	51.87140013004560,	52.471345647509800,	51.05601623573810,	52.092413266858000,	52.90877275080910,	47.538684191036000,	43.75738150862050,	41.45875625108040,	43.5049512833707,	43.081777390479400,	46.97838189282400,	48.760206435742000,	53.31484546434360,	53.1272816508022,	52.618358074841600,	49.82606028997130,	48.352115114157100,	44.62464629251290,	43.793128588742900,	42.44328641819320,	43.604326673100600,	46.12653934414550,	44.99077111745740,	44.86105351255670,	44.62345726628180,	44.661021336036400,	44.95746599915520,	46.040452069878900,	42.64843274133650,	44.7209155528554,	42.05356391699030,	39.06380817290800,	36.12184041230420,	40.49676016147820,	43.01159708910550,	44.28958209475460,	44.21826552047310,	48.44091647290830,	44.61619029792200,	40.36716575009730,	39.50076232343610,	40.007261505323300,	35.5719104668299,	34.41852712114550,	34.86250391131120,	33.36296975300370,	33.47169371031860,	36.01741876887610,	36.06686212467220,	32.344471583217900,	32.7918140823496,	31.727103623224800,	29.38382666775430,	28.052409927823100,	32.216149616592500,	31.824483359713300,	30.677880766629300,	29.32680017597160,	29.62626234066190,	26.291112610023000,	26.11193780860620,	24.657775927475600)
# Rhythmic Information Content
ric <- c(2.392785201064800,	2.314024838731470,	2.4665927478223800,	2.5744504044890400,	2.578827943436410,	2.556420820821030,	2.6901523306210300,	2.625536843348300,	2.663585944181630,	2.635952150688810,	2.5969090387987000,	2.621566726071430,	2.553684538337160,	2.4138517117462500,	2.461160164625040,	2.462941656053610,	2.527229927114220,	2.583081586399290,	2.6429323282174700,	2.670978797661910,	2.596885372161910,	2.5179473695428700,	2.4624414795614400,	2.458964066834170,	2.3865026402328600,	2.4812005344828600,	2.4802028344828600,	2.57020353497409,	2.4776784199740900,	2.4673455254642900,	2.3975644021688300,	2.3706124358663100,	2.3976313277829800,	2.4215844334496400,	2.4185883820770900,	2.4249444227095100,	2.4234265839644100,	2.3512091879775700,	2.317306807310900,	2.507210286016780,	2.5308151749298200,	2.4638723669298200,	2.398189900416670,	2.4762446890833300,	2.2099180430833300,	2.132920256972220,	2.154033647246730,	2.123194700877680,	1.9864064907824500,	1.9080662481157800,	1.9568463886386600,	1.8873935133445400,	1.886843192392160,	1.915404890487400,	1.9716067569722400,	1.8459250335604800,	1.8901127451441900,	1.8467029673998300,	1.8272872277919900,	1.7564190899738000,	1.8665875145620400,	1.8601065642786400,	1.8760362748049500,	1.8190804572699400,	1.83963095095415,	1.716701859313280,	1.7459471270325800,	1.7158843954887200)

# Full dataset
ts_mat <- matrix(c(tonality, mic, pitch_std, mis, od, npvi, ric), nrow=68)
ts_df <- data.frame(Tonality=tonality, MIC=mic, Pitch_STD=pitch_std, MIS=mis, OD=od, nPVI=npvi, RIC=ric)

# Range of parameters
# alpha = 1,2
# k = 1,2, 3, 4, NULL
# min.size = 5,6,7,8,9,10
to_analyze <- c(colnames(ts_df), "Multivariate")
alphas = list(1, 2)
k_list = list(1, 2, 3, 4, "NULL")
sizes = list(5, 6, 7, 8, 9, 10)

# This df will hold the changepoints
# Let's allow up to 7 changepoints, approximately 1 per decade
changepoints_df <- data.frame(feature = factor(), alpha=factor(), k=factor(), min_size=factor(), pos = numeric())

# Iterate through each feature we need to analyze (the multivariate analysis will be performed
# in the final iteration)
for (feat in to_analyze)
{
  mat <- 0
  # Check for multivariate
  if (feat == "Multivariate")
  {
    mat <- ts_mat
  } else {
    # If univariate, get the feature we need
    mat <- matrix(c(ts_df[[feat]]), nrow=68) 
  }
  # Iterate through the parameter settings
  for (a_val in alphas)
  {
    for (k_val in k_list)
    {
      for (s_val in sizes)
      {
        # Check for NULL. R doesn't appreciate NULL when iterating/storing info so 
        # I have to convert it to a string  
        k_to_use <- k_val
        if (is.character(k_val))
        {
          k_to_use <- NULL
        }
        # Changepoint detection
        cpts <- e.divisive(mat, sig.lvl = 0.05, R = 199, k = k_to_use, min.size = s_val, alpha = a_val)
        points <- cpts$estimates
        # Remove the first and last values (the first and last positions are always changepoints with this algorithm)
        points <- points[-c(1, length(points))]
        # Store information (changepoints + parameter settings used)
        for (point in points){
          info <- data.frame(feature=feat, alpha=a_val, k=k_val, min_size=s_val, pos = point)
          changepoints_df = rbind(changepoints_df, info)
        }
      }
    }
  }
}

# Save .csv
write.csv(changepoints_df, changepoints_csv_name, row.names = FALSE)
